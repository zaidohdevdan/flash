generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PROFESSIONAL
  SUPERVISOR
}

enum ReportStatus {
  SENT
  IN_REVIEW
  FORWARDED // Encaminhado ao Departamento
  RESOLVED
  ARCHIVED // Arquivado para histórico
}

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  email        String   @unique
  passwordHash String
  avatarUrl    String?
  statusPhrase String?
  role         Role     @default(PROFESSIONAL)
  supervisorId String?  @db.ObjectId
  supervisor   User?    @relation("Subordinates", fields: [supervisorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Subordinates User[]   @relation("Subordinates")
  reports      Report[]
  media        Media[] // <- NEW: Relação com Media
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Report {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  imageUrl   String
  comment    String
  feedback   String?
  feedbackAt DateTime?
  status     ReportStatus @default(SENT)
  userId     String       @db.ObjectId
  user       User         @relation(fields: [userId], references: [id])

  departmentId String?     @db.ObjectId
  department   Department? @relation(fields: [departmentId], references: [id])

  history ReportHistory[]
  media   Media[] // <- NEW: Relação com Media

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  reports   Report[]
  createdAt DateTime @default(now())
}

model ReportHistory {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  reportId  String       @db.ObjectId
  report    Report       @relation(fields: [reportId], references: [id])
  status    ReportStatus
  comment   String? // O feedback ou observação deste passo
  userName  String // Nome de quem registrou o passo para histórico rápido
  createdAt DateTime     @default(now())
}

model Media {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  publicId     String   @unique // @unique já cria um índice automaticamente
  url          String
  secureUrl    String
  format       String
  width        Int?
  height       Int?
  bytes        Int
  resourceType String // 'image', 'video', 'raw', 'auto'
  folder       String   @default("flash")
  uploadedAt   DateTime @default(now())

  // Relations
  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  reportId String? @db.ObjectId
  report   Report? @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reportId])
  @@map("media")
}

model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  fromId    String   @db.ObjectId
  toId      String   @db.ObjectId
  text      String?
  audioUrl  String?
  room      String // e.g., "chat:professionalUserId"
  createdAt DateTime @default(now())

  @@index([room])
}
