generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PROFESSIONAL
  SUPERVISOR
  MANAGER
}

enum ReportStatus {
  SENT
  IN_REVIEW
  FORWARDED // Encaminhado ao Departamento
  RESOLVED
  ARCHIVED // Arquivado para histórico
}

model User {
  id                    String         @id @default(auto()) @map("_id") @db.ObjectId
  name                  String
  email                 String         @unique
  passwordHash          String
  avatarUrl             String?
  statusPhrase          String?
  role                  Role           @default(PROFESSIONAL)
  supervisorId          String?        @db.ObjectId
  supervisor            User?          @relation("Subordinates", fields: [supervisorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Subordinates          User[]         @relation("Subordinates")
  departmentId          String?        @db.ObjectId
  department            Department?    @relation("DepartmentMembers", fields: [departmentId], references: [id])
  reports               Report[]
  media                 Media[] // <- NEW: Relação com Media
  notifications         Notification[] @relation("UserNotifications")
  createdEvents         AgendaEvent[]  @relation("CreatedEvents")
  participatingEventIds String[]       @db.ObjectId
  participatingEvents   AgendaEvent[]  @relation("EventParticipants", fields: [participatingEventIds], references: [id])
  notes                 Note[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  auditLogs AuditLog[]
}

model Report {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  imageUrl   String
  comment    String
  feedback   String?
  feedbackAt DateTime?
  status     ReportStatus @default(SENT)
  latitude   Float? // NEW: Geolocalização
  longitude  Float? // NEW: Geolocalização
  userId     String       @db.ObjectId
  user       User         @relation(fields: [userId], references: [id])

  departmentId String?     @db.ObjectId
  department   Department? @relation(fields: [departmentId], references: [id])

  history ReportHistory[]
  media   Media[] // <- NEW: Relação com Media

  agendaEvents AgendaEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  reports   Report[]
  members   User[]   @relation("DepartmentMembers")
  createdAt DateTime @default(now())
}

model ReportHistory {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  reportId       String       @db.ObjectId
  report         Report       @relation(fields: [reportId], references: [id])
  status         ReportStatus
  comment        String? // O feedback ou observação deste passo
  userName       String // Nome de quem registrou o passo para histórico rápido
  departmentName String? // NEW: Setor por onde passou
  createdAt      DateTime     @default(now())
}

model Media {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  publicId     String   @unique // @unique já cria um índice automaticamente
  url          String
  secureUrl    String
  format       String
  width        Int?
  height       Int?
  bytes        Int
  resourceType String // 'image', 'video', 'raw', 'auto'
  folder       String   @default("flash")
  uploadedAt   DateTime @default(now())

  // Relations
  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  reportId String? @db.ObjectId
  report   Report? @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reportId])
  @@map("media")
}

model ChatMessage {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  fromId             String    @db.ObjectId
  toId               String    @db.ObjectId
  text               String?
  audioUrl           String?
  audioPublicId      String?
  room               String // e.g., "chat:professionalUserId"
  createdAt          DateTime  @default(now())
  expiresAt          DateTime?
  deletedForSender   Boolean   @default(false)
  deletedForEveryone Boolean   @default(false)

  @@index([room])
}

model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  action    String // e.g., "DELETE_USER", "UPDATE_REPORT", "LOGIN"
  target    String? // e.g., "User:123", "Report:456"
  details   String? // JSON stringified details
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}

enum AgendaEventType {
  CONFERENCE
  FORWARDING
  TASK
  OTHER
}

model AgendaEvent {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  type        AgendaEventType @default(TASK)
  startTime   DateTime
  endTime     DateTime?

  // Relations
  createdById String @db.ObjectId
  createdBy   User   @relation("CreatedEvents", fields: [createdById], references: [id])

  participantIds String[] @db.ObjectId
  participants   User[]   @relation("EventParticipants", fields: [participantIds], references: [id])

  reportId String? @db.ObjectId
  report   Report? @relation(fields: [reportId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startTime])
}

model Notification {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  fromId       String?   @db.ObjectId
  type         String // e.g., "AGENDA_REMINDER", "CONFERENCE_INVITE", "REPORT_FORWARDED"
  title        String
  message      String
  read         Boolean   @default(false)
  link         String? // Link para ação (ex: reportId ou agenda)
  scheduledFor DateTime? // Data prevista para entrega/alerta

  createdAt DateTime @default(now())
}

model Note {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  userId  String @db.ObjectId
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
